{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",

  "contentVersion": "1.0.0.0",
  "parameters": {
    "nsgNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "Required. Name prefix for the Network Security Group(s)."
      }
    },
    "nsgNameSuffix": {
      "type": "string",
      "defaultValue": "-01",
      "metadata": {
        "description": "Optional. Name suffix for NSG(s)."
      }
    },
    "nsgs": {
      "type": "array",
      "metadata": {
        "description": "Required. Array of (array of Network Security Group and NSG Security Rules). When rules not provided, an NSG including only the built-in rules will be deployed."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Optional. Location for all resources."
      }
    },
    "diagnosticStorageAccountId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Resource identifier of the Diagnostic Storage Account."
      }
    },
    "diagnosticLogsRetentionInDays": {
      "type": "int",
      "defaultValue": 365,
      "minValue": 0,
      "maxValue": 365,
      "metadata": {
        "description": "Optional. Specifies the number of days that logs will be kept for; a value of 0 will retain data indefinitely."
      }
    },
    "workspaceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Resource identifier of Log Analytics."
      }
    },
    "eventHubAuthorizationRuleId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Resource ID of the event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
      }
    },
    "eventHubName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Name of the event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category."
      }
    },
    "lockForDeletion": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Switch to lock NSG from deletion."
      }
    },
    "roleAssignments": {
      "defaultValue": [
      ],
      "type": "array",
      "metadata": {
        "description": "Optional. Array of role assignment objects that contain the 'roleDefinitionIdOrName' and 'principalId' to define RBAC role assignments on this resource. In the roleDefinitionIdOrName attribute, you can provide either the display name of the role definition, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "mtb:app-code": "FWP",
        "mtb:cc-cld-consumer": "",
        "mtb:cc-cld-requestor": "",
        "mtb:cc-cld-provider": "",
        "mtb:gl": "",
        "mtb:cloud": "AzUsEast2",
        "mtb:env": "PROD",
        "mtb:deploy": "ADO",
        "mtb:cmr-num": "RFC0000000",
        "mtb:ssr-num": "SSR00000000"
      },
      "metadata": {
        "description": "Optional. Tags of the NSG resources."
      }
    },
    "cuaId": {
      "type": "string",
      "defaultValue": "29362fa7-15c9-5061-8565-f82f26129ab8",
      "metadata": {
        "description": "Optional. Customer Usage Attribution id (GUID). This GUID must be previously registered"
      }
    }
  },
  "variables": {
    "emptyArray": [
    ],
    "diagnosticsMetrics": [
    ],
    "diagnosticsLogs": [
      {
        "category": "NetworkSecurityGroupEvent",
        "enabled": true,
        "retentionPolicy": {
          "days": "[parameters('diagnosticLogsRetentionInDays')]",
          "enabled": true
        }
      },
      {
        "category": "NetworkSecurityGroupRuleCounter",
        "enabled": true,
        "retentionPolicy": {
          "days": "[parameters('diagnosticLogsRetentionInDays')]",
          "enabled": true
        }
      }
    ]
  },
  "resources": [
    {
      "condition": "[not(empty(parameters('cuaId')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2018-02-01",
      "name": "[concat('pid-', parameters('cuaId'))]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [
          ]
        }
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2020-04-01",
      "name": "[concat(parameters('nsgNamePrefix'), parameters('nsgs')[copyIndex('nsg')].nsg, parameters('nsgNameSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[resourceGroup().tags]",
      "copy": {
        "name": "nsg",
        "count": "[length(parameters('nsgs'))]"
      },
      "dependsOn": [],
      "properties": {
        "copy": [
          {
            "name": "securityRules",
            "count": "[length(parameters('nsgs')[copyIndex('nsg')].rules)]",
            "input": {
              "name": "[parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].name]",
              "properties": {
                "description": "[parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.description]",
                "protocol": "[parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.protocol]",
                "sourcePortRange": "[parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.sourcePortRange]",
                "destinationPortRange": "[if(equals(parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.destinationPortRange, ''), json('null'), parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.destinationPortRange)]",
                "sourceAddressPrefix": "[if(equals(parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.sourceAddressPrefix, ''), json('null'), parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.sourceAddressPrefix)]",
                "destinationAddressPrefix": "[if(equals(parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.destinationAddressPrefix, ''), json('null'), parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.destinationAddressPrefix)]",
                "access": "[parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.access]",
                "priority": "[int(parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.priority)]",
                "direction": "[parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.direction]",
                "sourcePortRanges": "[if(equals(length(parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.sourcePortRanges), 0), json('null'), parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.sourcePortRanges)]",
                "destinationPortRanges": "[if(equals(length(parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.destinationPortRanges), 0), json('null'), parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.destinationPortRanges)]",
                "sourceAddressPrefixes": "[if(equals(length(parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.sourceAddressPrefixes), 0), json('null'), parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.sourceAddressPrefixes)]",
                "destinationAddressPrefixes": "[if(equals(length(parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.destinationAddressPrefixes), 0), json('null'), parameters('nsgs')[copyIndex('nsg')].rules[copyIndex('securityRules')].properties.destinationAddressPrefixes)]"
              }
            }
          }
        ]
      },
      "resources": [
        {
          "type": "Microsoft.Network/networkSecurityGroups/providers/diagnosticsettings",
          "apiVersion": "2017-05-01-preview",
          "name": "[concat(parameters('nsgNamePrefix'), parameters('nsgs')[copyIndex()].nsg, parameters('nsgNameSuffix'), '/Microsoft.Insights/service')]",
          "location": "[parameters('location')]",
          "condition": "[or(not(empty(parameters('diagnosticStorageAccountId'))),not(empty(parameters('workspaceId'))),not(empty(parameters('eventHubAuthorizationRuleId'))),not(empty(parameters('eventHubName'))))]",
          "dependsOn": [
            "[concat('Microsoft.Network/networkSecurityGroups/', parameters('nsgNamePrefix'), parameters('nsgs')[copyIndex()].nsg, parameters('nsgNameSuffix'))]"
          ],
          "properties": {
            "storageAccountId": "[if(empty(parameters('diagnosticStorageAccountId')), json('null'), parameters('diagnosticStorageAccountId'))]",
            "workspaceId": "[if(empty(parameters('workspaceId')), json('null'), parameters('workspaceId'))]",
            "eventHubAuthorizationRuleId": "[if(empty(parameters('eventHubAuthorizationRuleId')), json('null'), parameters('eventHubAuthorizationRuleId'))]",
            "eventHubName": "[if(empty(parameters('eventHubName')), json('null'), parameters('eventHubName'))]",
            "metrics": "[if(and(empty(parameters('diagnosticStorageAccountId')), empty(parameters('workspaceId')), empty(parameters('eventHubAuthorizationRuleId')), empty(parameters('eventHubName'))), json('null'), variables('diagnosticsMetrics'))]",
            "logs": "[if(and(empty(parameters('diagnosticStorageAccountId')), empty(parameters('workspaceId')), empty(parameters('eventHubAuthorizationRuleId')), empty(parameters('eventHubName'))), json('null'), variables('diagnosticsLogs'))]"
          }
        }
      ]
    }
  ],
  "functions": [
  ],
  "outputs": {
    "networkSecurityGroupResourceGroup": {
      "type": "string",
      "value": "[resourceGroup().name]",
      "metadata": {
        "description": "The name of the Resource Group the Network Security Groups were created in."
      }
    }
  }
}
